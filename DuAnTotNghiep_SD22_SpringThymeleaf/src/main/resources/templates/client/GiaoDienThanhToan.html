<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{client/fragmentsClient/head :: head}"></div>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SHOSE SEE</title>
    <link rel="stylesheet" href="/css/output.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml"
          href="https://bizweb.dktcdn.net/100/048/601/themes/734017/assets/index-cate-icon-4.png?1610907247309"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        .btn-payment {
            border: 1px solid #808080;
            color: #080808;
            position: relative;
            padding-right: 2.5rem;
        }
        .btn-payment.active {
            border: 1px solid #FFA500 !important;
            color: #FFA500;
        }


        .icon-payment {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }
        .labl > input + div{ /* DIV STYLES */
            cursor:pointer;
            border:2px solid transparent;
        }
    </style>
</head>
<body class="bg-gray-100">
<div>
    <div th:replace="~{client/fragmentsClient/header :: header}"></div>
    <div class="flex justify-center">
        <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-32 flex gap-40">
            <div class="grid gap-1 grid-cols-1">
                <div>
                    <h1 class="text-orange-700 text-xl m-5">Địa chỉ đơn hàng</h1>
                </div>
                <div class="diaChiKhachHang ml-10 mb-5" id="diaChiKhachHang">

                </div>
            </div>
        </div>
    </div>
    <div class="flex justify-center">
        <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-7 gap-40">
                <table id="tableHoaDonChiTiet" class="min-w-full divide-y divide-gray-200  ">
                    <thead class="">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                            STT
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider w-[30%]">
                           <span class="ml-14"> Sản
                            phẩm</span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                           size
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                            Đơn giá
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">Số
                            lượng
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">Thành
                            tiền
                        </th>
                    </tr>
                    </thead>
                    <tbody id="danhSachSanPham" class="bg-white divide-y divide-gray-200 h-full">
                    </tbody>
                </table>


            <div class="soLuongVaTongTien ml-[60%]" id="soLuongVaTongTien"></div>

        </div>
    </div>

    <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-5">
        <div class="grid gap-1 grid-cols-2 m-3">
            <div class="text-orange-500 text-xl">Voucher</div>
            <div id="voucher" class="ml-[50%] text-orange-500 py-2 px-4 border-2 border-orange-500 rounded-lg text-center cursor-pointer bg-white font-semibold w-[200px]">
            </div>
        </div>

    </div>
    <div class="flex justify-center">
        <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-5 gap-40 mb-20">
            <div class="m-10">
                <span class=" text-xl font-bold mr-10">Phương thức thanh toán</span>
                <button id="btnCOD" class="btn-payment w-64 h-14 py-2 px-4 rounded-md mr-5 active">
                    Thanh toán khi nhận hàng
                </button>

                <button id="btnVNPAY" class="btn-payment w-64 h-14 border py-2 px-4 rounded-md relative">
                    <span class="flex"> Thanh toán VNPAY</span>
                    <img src="https://asset.brandfetch.io/idV02t6WJs/idyWhNall8.svg" class="icon-payment absolute w-[40%] h-[40%]">
                </button>
            </div>
            <div class="grid gap-4 grid-cols-2">
                <div>
                    <div class="flex">
                        <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/05/Logo-GHN-Slogan-En.png" class="w-[20%] h-[20%]">
                        <p class="ml-10">Thời gian nhận hàng dự kiện: <span id="thoiGianDuKien"></span></p>
                    </div>
                </div>
                <div class="ml-28">
                   <div class="grid gap-4 grid-cols-2">
                       <div class="text-gray-600">
                           <div class="mb-5">Tổng tiền</div>
                           <div class="mb-5">Phí vận chuyển</div>
                           <div class="mb-5">Mã giảm giá</div>
                           <div class="mb-5">Tổng thanh toán</div>
                       </div>
                       <div class="text-gray-600">
                           <div class="mb-5"><span class="ml-1" id="tongTien"></span></div>
                           <div class="mb-5"><span class="ml-1" id="phiVanChuyen"></span></div>
                           <div class="mb-5"><span class="ml-1" id="maGiamGia"></span></div>
                           <div class="mb-5"><span class="ml-1 text-orange-500 text-2xl" id="tongThanhToan"></span></div>
                       </div>
                   </div>
                    <div id="datHang">
                        <button type="button" class="tiepTuc ml-14 w-[70%] h-16 mb-10 font-bold text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">
                            Đặt hàng
                        </button>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalDiaChi" class="fixed z-10 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full h-[50%]">
            <div id="listDiaChi" class="bg-white px-4 pt-5 pb-4">

            </div>
            <div class="bg-gray-50 px-4 py-3 flex justify-end">
                <button id="huyDiaChi"
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">Hủy
                </button>
                <button id="xacNhanDiaChi"
                        class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];
        let sale = JSON.parse(localStorage.getItem('sale')) || [];
        let discount = 0;
        let ship = 0;
        var tongTien = 0;
        let nguoiNhan = '';
        let sdtNguoiNhan = '';
        let idKhachHang = '';
        let soLuongSPTong = 0;
        var tongTienSauKhiGiam = 0;


        const formatVND = (tongtien) => {
            return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
        }


        const DateNow = new Date();
        const DateShip = DateNow.setDate(DateNow.getDate() + 4);

        $('#thoiGianDuKien').text(formatDateFromTimestamp(DateShip))

        function formatDateFromTimestamp(timestamp) {
            const date = new Date(timestamp);

            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        $(document).ready(function () {
            $('#btnCOD').click(function () {
                $(this).addClass('active');
                $('#btnVNPAY').removeClass('active');
            });

            $('#btnVNPAY').click(function () {
                $(this).addClass('active');
                $('#btnCOD').removeClass('active');
            });
        });


        function hienThiSanPhamDaChon() {
            let list = "";
            if (Array.isArray(selectedProducts) && selectedProducts.length > 0) {
                for (let i = 0; i < selectedProducts.length; i++) {
                    const item = selectedProducts[i];
                    tongTien += item.soLuong * item.sanPhamChiTiet.giaBan;
                    soLuongSPTong += item.soLuong;
                    list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap flex">
                            <div>
                                <img src="https://res.cloudinary.com/deapopcoc/image/upload/${item.sanPhamChiTiet.anh}" alt="Ảnh" class="w-24 h-auto mt-2">
                            </div>
                            <div class="m-4 font-bold"><span>${item.sanPhamChiTiet.ten}</span></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.sanPhamChiTiet.kichCo.ten}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(item.sanPhamChiTiet.giaBan)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.soLuong}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(item.soLuong * item.sanPhamChiTiet.giaBan)}</td>
                    </tr>
            `;
                }
                discount = sale[0].giamToiDa;
                tongTienSauKhiGiam = tongTien - discount;

                $('#soLuongVaTongTien').html(`
            <div>Tổng số tiền(${soLuongSPTong} sản phẩm): <span class="text-orange-500 text-xl ml-5">${formatVND(tongTien - discount)}</span></div>
        `);


                $('#tongTien').text(formatVND(tongTien));
                $('#phiVanChuyen').text(ship);
                $('#maGiamGia').text(formatVND(discount));
                $('#tongThanhToan').text(formatVND(tongTienSauKhiGiam));
                $('#voucher').text(formatVND(-sale[0].giamToiDa));


            } else {
                list = "<p>Không có sản phẩm nào được chọn.</p>";
            }

            $("#danhSachSanPham").html(list);


        }

        function thongTinNguoiMua(dckh) {

            if (dckh.trangThai == 1) {
                $('#diaChiKhachHang').html(`
                    <div class="flex">
                        <p class="font-bold">${dckh.idKH.ten} |<span class="font-normal ml-1">${dckh.idKH.sdt}</span> <span id="diaChiSpan" class="font-normal ml-4">${dckh.soNha}, ${dckh.phuongXa}, ${dckh.quanHuyen}, ${dckh.thanhPho}</span></p>
                        <button class=" ml-10 bg-blue-500 hover:bg-blue-700 text-white px-2 rounded">
                            Mặc định
                        </button>
                        <a class="ml-10 text-blue-700"><button id="thayDoiDiaChi">Thay đổi</button></a>
                    </div>
                `);
            }
        }

        function getKhachHang() {
            $.ajax({
                url: '/api/session/user',
                method: 'GET',
                success: function (response) {
                    idKhachHang = response.id;
                    nguoiNhan = response.ten;
                    sdtNguoiNhan = response.sdt;
                    getDuLieu(idKhachHang);
                    getDiaChiKhachHang(response);

                    $("#datHang").off('click', '.tiepTuc').on('click', '.tiepTuc', function () {

                        if ($('#btnCOD').hasClass('active')) {
                            let ship2 = ship;
                            var tongTien2 = tongTien;
                            let nguoiNhan2 = nguoiNhan;
                            let sdtNguoiNhan2 = sdtNguoiNhan;
                            let diaChiNguoiNhan = $('#diaChiSpan').text().trim();
                            var tongTienSauKhiGiam2 = tongTienSauKhiGiam;

                            taoHoaDonDatHang(nguoiNhan2, idKhachHang, tongTien2, ship2, sdtNguoiNhan2, diaChiNguoiNhan, tongTienSauKhiGiam2);

                            window.location.href = '/Client';

                        } else if ($('#btnVNPAY').hasClass('active')) {
                            let ship2 = ship;
                            var tongTien2 = tongTien;
                            let nguoiNhan2 = nguoiNhan;
                            let sdtNguoiNhan2 = sdtNguoiNhan;
                            let diaChiNguoiNhan = $('#diaChiSpan').text().trim();
                            var tongTienSauKhiGiam2 = tongTienSauKhiGiam;

                            taoHoaDonDatHangTraTruoc(nguoiNhan2, idKhachHang, tongTien2, ship2, sdtNguoiNhan2, diaChiNguoiNhan, tongTienSauKhiGiam2);

                        } else {
                            alert("Vui lòng chọn phương thức thanh toán.");
                        }
                    });
                },
            });
        }

        function getDuLieu(idKhachHang) {
            $.ajax({
                url: `/api/gio-hang/cho-thanh-toan/${idKhachHang}`,
                method: 'GET',
                success: function (response) {
                    thongTinNguoiMua(response.diaChiKH[0]);

                },
            });
        }

        function chuyenKhoan(amount, TxnRef){
            $.ajax({
                url: `/api/payment/create_payment?amount=${amount}&TxnRef=${TxnRef}`,
                method: 'GET',
                contentType: 'application/json',
                data:{},
                success: function (response) {
                    window.location.href = response.url;
                },
            });
        }

        function taoHoaDonDatHangTraTruoc(nguoiNhan, KhachHang, tongTien, tienShip, sdtNguoiNhan, diaChiNguoinhan, tongTienSauKhiGiam) {
            let idPhieuGiamGia = sale[0].id
            $.ajax({
                url: `/api/gio-hang/tao-hoa-don-dat-hang`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    phieuGiamGia: {
                        id: idPhieuGiamGia
                    },
                    ma: "1",
                    nguoiNhan: nguoiNhan,
                    tongTien: tongTien,
                    tongTienSauGiam: tongTienSauKhiGiam,
                    tienShip: tienShip,
                    sdtNguoiNhan: sdtNguoiNhan,
                    diaChiNguoiNhan: diaChiNguoinhan,
                    khachHang: { id: KhachHang }
                }),
                success: function (response) {
                    const idHoaDon = response.id;
                    addHistoryLog(idHoaDon);
                    addSanPhamVaoHDCT(idHoaDon);
                    addPhuongThucThanhToanChuyenKhoan(idHoaDon);
                    chuyenKhoan(response.tongTienSauGiam, response.ma);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tạo hóa đơn:', error);
                }
            });
        }


        function taoHoaDonDatHang(nguoiNhan, KhachHang, tongTien, tienShip, sdtNguoiNhan, diaChiNguoinhan, tongTienSauKhiGiam) {
            let idPhieuGiamGia = sale[0].id
            $.ajax({
                url: `/api/gio-hang/tao-hoa-don-dat-hang`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    phieuGiamGia: {
                        id: idPhieuGiamGia
                    },
                    ma: "1",
                    nguoiNhan: nguoiNhan,
                    tongTien: tongTien,
                    tongTienSauGiam: tongTienSauKhiGiam,
                    tienShip: tienShip,
                    sdtNguoiNhan: sdtNguoiNhan,
                    diaChiNguoiNhan: diaChiNguoinhan,
                    khachHang: { id: KhachHang }
                }),
                success: function (response) {
                    const idHoaDon = response.id;
                    addHistoryLog(idHoaDon);
                    addSanPhamVaoHDCT(idHoaDon);
                    addPhuongThucThanhToan(idHoaDon);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tạo hóa đơn:', error);
                }
            });
        }


        function addHistoryLog(idHoaDon) {

            $.ajax({
                url: `/api/hoa-don/lich-su-hoa-don/add/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ghiChu: "Chờ xác nhận", hanhDong: 1}),
                success: function (response) {
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi thêm lịch sử:', error);
                }
            });
        }

        function addSanPhamVaoHDCT(idHoaDon) {
            let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];
            selectedProducts.forEach(product => {
                const productData = {
                    sanPhamChiTiet: product.sanPhamChiTiet,
                    soLuong: product.soLuong,
                    gia: product.sanPhamChiTiet.giaBan,
                    trangThai: 1
                };
                $.ajax({
                    url: `/api/gio-hang/them-san-pham-vao-hoa-don/${idHoaDon}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function (response) {
                    },
                    error: function (xhr, status, error) {

                    }
                });
                // $.ajax({
                //     url: `/api/gio-hang/delete-sp/${pro}`,
                //     method: 'POST',
                //     contentType: 'application/json',
                //     data: JSON.stringify(productData),
                //     success: function (response) {
                //     },
                //     error: function (xhr, status, error) {
                //
                //     }
                // });
            });
            localStorage.removeItem('selectedProducts');
        }

        function addPhuongThucThanhToan(idHoaDon) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenThanhToan: "Tiền mặt",
                    loaiThanhToan: false,
                    trangThai: 1
                }),
                success: function (response) {
                },
            });
        }

        function addPhuongThucThanhToanChuyenKhoan(idHoaDon) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenThanhToan: "Chuyển Khoản",
                    loaiThanhToan: true,
                    trangThai: 1
                }),
                success: function (response) {
                },
            });
        }

        function getDiaChiKhachHang(khachHang) {
            $.ajax({
                url: `/api/gio-hang/dia-chi-khach-hang/${khachHang.id}`,
                method: 'GET',
                success: function (response) {
                    let list = "";
                    $("#listDiaChi").empty();

                    response.forEach((diaChi, i) => {

                        list += `
                    <div class="grid gap-1 grid-cols-1 border-1 border-gray-300 p-4 rounded-lg">
                        <div class="flex">
                             <div class="radioDiaChi mr-2">
                                    <input type="radio" name="phieuGiamGia" id="radioDiaChi" value="${diaChi.id}" data-item='${JSON.stringify(diaChi)}'>
                            </div>
                            <div class="mr-3">${khachHang.ten}</div>
                            <div class="text-gray-600">| ${khachHang.sdt}</div>
                            </div>
                            <div>
                                <div class="ml-5 text-gray-600">${`${diaChi.moTaChiTiet}, ${diaChi.thanhPho}`}</div>
                            </div>
                    </div>
                    <br>
                `;
                    });
                    $("#listDiaChi").html(list);
                },
            });
        }

        // <div class="mt-10">
        //     <input type="radio" name="phieuGiamGia" value="${diaChi.id}" data-item='${JSON.stringify(diaChi)}'>
        // </div>

        function hideModalDiaChi() {
            $('#modalDiaChi').addClass('hidden');
            $('#modalDiaChi').val('');
            $('#modalDiaChi').addClass('hidden');
        }

        function showModalDiaChi() {
            $('#modalDiaChi').removeClass('hidden');
        }

        $(document).on('click', '#thayDoiDiaChi', function () {
            showModalDiaChi();
        });

        // $('#huyPhieuGiamGia').click(function () {
        //     hideModalPhieuGiamGia();
        // })


        hienThiSanPhamDaChon();
        getKhachHang();

    });
</script>
</body>
<div th:replace="~{client/fragmentsClient/footer :: footer}"></div>
</html>