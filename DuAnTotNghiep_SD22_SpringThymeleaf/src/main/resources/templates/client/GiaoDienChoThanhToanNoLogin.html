<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{client/fragmentsClient/head :: head}"></div>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SHOSE SEE</title>
    <link rel="stylesheet" href="/css/output.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/svg+xml"
          href="https://bizweb.dktcdn.net/100/048/601/themes/734017/assets/index-cate-icon-4.png?1610907247309"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <style>
        .btn-payment {
            border: 1px solid #808080;
            color: #080808;
            position: relative;
            padding-right: 2.5rem;
        }

        .btn-payment.active {
            border: 1px solid #FFA500 !important;
            color: #FFA500;
        }


        .icon-payment {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
        }

        .labl > input + div { /* DIV STYLES */
            cursor: pointer;
            border: 2px solid transparent;
        }

        /* Style for invalid input fields */
        .is-invalid {
            border: 1px solid red;
        }

        /* Style for error messages */
        .error {
            color: red;
            font-size: 0.875em; /* Adjust font size if needed */
        }

    </style>

</head>
<body class="bg-gray-100">
<div>
    <div th:replace="~{client/fragmentsClient/header :: header}"></div>
    <form method="post" class="row g-3"
          enctype="multipart/form-data" id="myForm">
        <div class="flex justify-center">
            <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-32 flex gap-40">
                <div class="grid gap-1 grid-cols-1">
                    <div>
                        <h1 class="text-black-700 text-xl m-5"><span>Thông Tin Nhận Hàng</span></h1>
                    </div>
                    <!--                //validate cho tôi -->

                        <div class="row mb-12">
                            <div class="row">
                                <div class="col-6">
                                    <label for="ten" class="form-label">Tên Khách Hàng:</label>
                                    <input type="text" id="ten" name="ten" class="form-control"
                                           placeholder="Nhập tên Khách Hàng">
                                    <div id="tenError" class="error"></div>
                                </div>
                                <div class="col-6">
                                    <label for="sdt" class="form-label">Số Điện Thoại:</label>
                                    <input type="text" id="sdt" name="sdt" class="form-control"
                                           placeholder="Nhập SĐT">
                                    <div id="sdtError" class="error"></div>
                                </div>

                            </div>

                            <div class="abc">
                                <div class="row">
                                    <div class="col-12">
                                        <label for="diachi" class="form-label">Địa chỉ:</label>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <select class="form-select form-select-sm mb-3" id="city"
                                                aria-label="Chọn tỉnh thành" oninput="validateForm()">
                                            <option value="" selected>Chọn tỉnh thành</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select form-select-sm mb-3" id="district"
                                                aria-label="Chọn quận huyện" oninput="validateForm()">
                                            <option value="" selected>Chọn quận huyện</option>
                                        </select>
                                    </div>
                                    <div class="col-4">
                                        <select class="form-select form-select-sm mb-3" id="ward"
                                                aria-label="Chọn phường xã" oninput="validateForm()">
                                            <option value="" selected>Chọn phường xã</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <label>Địa chỉ Chi tiết:</label>
                                        <div class="form-group col-12">
                                            <textarea class="form-control" id="diachi" name="diachi" rows="3"
                                                      oninput="validateForm()"></textarea>
                                            <input class="col-12" id="dc" name="dc" rows="3"
                                                   style="display: none"></input>
                                        </div>
                                    </div>
                                    <div class="row">

                                        <div class="col-6">
                                            <label for="email" class="form-label">Email:</label>
                                            <input type="email" id="email" name="email" class="form-control"
                                                   placeholder="Nhập Email">
                                            <div id="emailError" class="error"></div>
                                        </div>
                                        <div class="col-6">
                                            <label for="ghichu" class="form-label">Ghi Chú:</label>
                                            <input type="text" id="ghichu" name="ghichu" class="form-control"
                                                   placeholder="Nhập Ghi Chú">

                                        </div>

                                    </div>
                                </div>
                                <span id="dcError" class="error"></span>
                            </div>
                        </div>
                    <!--                đến đây-->
                    <div class="diaChiKhachHang ml-10 mb-5" id="diaChiKhachHang">

                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-center">
            <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-7 gap-40">
                <table id="tableHoaDonChiTiet" class="min-w-full divide-y divide-gray-200  ">
                    <thead class="">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                            STT
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider w-[30%]">
                           <span class="ml-14"> Sản
                            phẩm</span>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                            size
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">
                            Đơn giá
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">Số
                            lượng
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-black uppercase tracking-wider">Thành
                            tiền
                        </th>
                    </tr>
                    </thead>
                    <tbody id="danhSachSanPham" class="bg-white divide-y divide-gray-200 h-full">
                    </tbody>
                </table>


                <div class="soLuongVaTongTien ml-[60%]" id="soLuongVaTongTien"></div>

            </div>
        </div>

        <!--    <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-5">-->
        <!--        <div class="grid gap-1 grid-cols-2 m-3">-->
        <!--            <div class="text-orange-500 text-xl">Voucher</div>-->
        <!--            <div id="voucher" class="ml-[50%] text-orange-500 py-2 px-4 border-2 border-orange-500 rounded-lg text-center cursor-pointer bg-white font-semibold w-[200px]">-->
        <!--            </div>-->
        <!--        </div>-->

        <!--    </div>-->
        <div class="flex justify-center">
            <div class="container bg-white w-[70%] p-2 rounded-lg shadow-md mt-5 gap-40 mb-20">
                <div class="m-10">
                    <span class=" text-xl font-bold mr-10">Phương thức thanh toán</span>
                    <button id="btnCOD" class="btn-payment w-64 h-14 py-2 px-4 rounded-md mr-5 active">
                        Thanh toán khi nhận hàng
                    </button>

                    <button id="btnVNPAY" class="btn-payment w-64 h-14 border py-2 px-4 rounded-md relative">
                        <span class="flex"> Thanh toán VNPAY</span>
                        <img src="https://asset.brandfetch.io/idV02t6WJs/idyWhNall8.svg"
                             class="icon-payment absolute w-[40%] h-[40%]">
                    </button>
                </div>
                <div class="grid gap-4 grid-cols-2">
                    <div>
                        <div class="flex">
                            <img src="https://cdn.haitrieu.com/wp-content/uploads/2022/05/Logo-GHN-Slogan-En.png"
                                 class="w-[20%] h-[20%]">
                            <p class="ml-10">Thời gian nhận hàng dự kiện: <span id="thoiGianDuKien"></span></p>
                        </div>
                    </div>
                    <div class="ml-28">
                        <div class="grid gap-4 grid-cols-2">
                            <div class="text-gray-600">
                                <div class="mb-5">Tổng tiền</div>
                                <div class="mb-5">Phí vận chuyển</div>
                                <!--                            <div class="mb-5">Mã giảm giá</div>-->
                                <div class="mb-5">Tổng thanh toán</div>
                            </div>
                            <div class="text-gray-600">
                                <div class="mb-5"><span class="ml-1" id="tongTien"></span></div>
                                <div class="mb-5"><span class="ml-1" id="phiVanChuyen"></span></div>
                                <!--                            <div class="mb-5"><span class="ml-1" id="maGiamGia"></span></div>-->
                                <div class="mb-5"><span class="ml-1 text-orange-500 text-2xl" id="tongThanhToan"></span>
                                </div>
                            </div>
                        </div>
                        <div id="datHang">
                            <button type="button"
                                    class="tiepTuc ml-14 w-[70%] h-16 mb-10 font-bold text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5">
                                Đặt hàng
                            </button>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </form>
</div>


<div id="modalDiaChi" class="fixed z-10 inset-0 overflow-y-auto hidden">
    <div class="flex items-center justify-center min-h-screen">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="bg-white rounded-lg overflow-hidden shadow-xl transform transition-all max-w-lg w-full h-[50%]">
            <div id="listDiaChi" class="bg-white px-4 pt-5 pb-4">

            </div>
            <div class="bg-gray-50 px-4 py-3 flex justify-end">
                <button id="huyDiaChi"
                        class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">Hủy
                </button>
                <button id="xacNhanDiaChi"
                        class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded">Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    // Attach validation to form submission


    var citis = document.getElementById("city");
    var districts = document.getElementById("district");
    var wards = document.getElementById("ward");
    var Parameter = {
        url: "https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json",
        method: "GET",
        responseType: "json", // Chỉnh responseType thành json để nhận dữ liệu JSON trực tiếp
    };

    // Gửi request lấy dữ liệu
    axios(Parameter).then(function (response) {
        renderCity(response.data); // Gọi hàm renderCity khi có dữ liệu trả về
    }).catch(function (error) {
        console.error('Error fetching data: ', error);
    });

    function renderCity(data) {
        // Hàm để render danh sách các tỉnh/thành phố vào dropdown citis
        data.forEach(function (city) {
            citis.options[citis.options.length] = new Option(city.Name, city.Id);
        });

        // Sự kiện khi chọn tỉnh/thành phố
        citis.onchange = function () {
            clearOptions(districts); // Xóa các option cũ của districts
            clearOptions(wards); // Xóa các option cũ của wards

            // Lọc ra thông tin của tỉnh/thành phố được chọn
            var selectedCity = data.find(function (city) {
                return city.Id === citis.value;
            });

            if (selectedCity) {
                // Log tên của tỉnh/thành phố được chọn
                console.log("Selected city:", selectedCity.Name);

                // Render các quận/huyện vào dropdown districts
                selectedCity.Districts.forEach(function (district) {
                    districts.options[districts.options.length] = new Option(district.Name, district.Id);
                });
            }
        };

        // Sự kiện khi chọn quận/huyện
        districts.onchange = function () {
            clearOptions(wards); // Xóa các option cũ của wards

            // Lấy thông tin của tỉnh/thành phố được chọn
            var selectedCity = data.find(function (city) {
                return city.Id === citis.value;
            });

            if (selectedCity) {
                // Lọc ra thông tin của quận/huyện được chọn
                var selectedDistrict = selectedCity.Districts.find(function (district) {
                    return district.Id === districts.value;
                });

                if (selectedDistrict) {
                    // Log tên của quận/huyện được chọn
                    console.log("Selected district:", selectedDistrict.Name);

                    // Render các phường/xã vào dropdown wards
                    selectedDistrict.Wards.forEach(function (ward) {
                        wards.options[wards.options.length] = new Option(ward.Name, ward.Id);

                    });
                }
            }
        };
        wards.onchange = function () {
            // Lấy thông tin của tỉnh/thành phố được chọn
            var selectedCity = data.find(function (city) {
                return city.Id === citis.value;
            });

            if (selectedCity) {
                // Lọc ra thông tin của quận/huyện được chọn
                var selectedDistrict = selectedCity.Districts.find(function (district) {
                    return district.Id === districts.value;
                });

                if (selectedDistrict) {
                    var selectedWard = selectedDistrict.Wards.find(function (ward) {
                        return ward.Id === wards.value;
                    });

                    if (selectedWard) {
                        // Tạo chuỗi để log các thông tin
                        var logString = selectedWard.Name;
                        logString += "," + selectedDistrict.Name;
                        logString += "," + selectedCity.Name;

                        // Log chuỗi kết quả ra console
                        console.log(logString);
                        var logTextarea = document.getElementById("dc");
                        logTextarea.value = logString;

                        // Ẩn textarea
                        logTextarea.style.display = "none";
                    }
                }
            }
        };


    }


    function clearOptions(selectElement) {
        for (var i = selectElement.options.length - 1; i > 0; i--) {
            selectElement.remove(i);
        }
    }

</script>
<script>
    function validateForm() {
        let isValid = true;

        // Get form elements
        const ten = document.getElementById('ten');
        const sdt = document.getElementById('sdt');
        const email = document.getElementById('email');
        const city = document.getElementById('city');
        const district = document.getElementById('district');
        const ward = document.getElementById('ward');
        const diachi = document.getElementById('diachi');

        // Clear previous error messages and styles
        ten.classList.remove('is-invalid');
        sdt.classList.remove('is-invalid');
        email.classList.remove('is-invalid');
        city.classList.remove('is-invalid');
        district.classList.remove('is-invalid');
        ward.classList.remove('is-invalid');
        diachi.classList.remove('is-invalid');

        document.getElementById('tenError').innerText = '';
        document.getElementById('sdtError').innerText = '';
        document.getElementById('emailError').innerText = '';
        document.getElementById('dcError').innerText = '';

        // Validate 'Tên Khách Hàng'
        if (ten.value.trim() === '') {
            document.getElementById('tenError').innerText = 'Vui lòng nhập tên khách hàng';
            ten.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Số Điện Thoại'
        const phoneRegex = /^[0-9]{10}$/;
        if (sdt.value.trim() === '') {
            document.getElementById('sdtError').innerText = 'Vui lòng nhập số điện thoại';
            sdt.classList.add('is-invalid');
            isValid = false;
        } else if (!phoneRegex.test(sdt.value.trim())) {
            document.getElementById('sdtError').innerText = 'Số điện thoại phải là số và gồm 10 chữ số';
            sdt.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Email'
        if (email.value.trim() === '') {
            document.getElementById('emailError').innerText = 'Vui lòng nhập email';
            email.classList.add('is-invalid');
            isValid = false;
        } else if (!email.value.includes('@')) {
            document.getElementById('emailError').innerText = 'Email không hợp lệ';
            email.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Chọn tỉnh thành'
        if (city.value === '') {
            document.getElementById('dcError').innerText = 'Vui lòng chọn tỉnh thành';
            city.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Chọn quận huyện'
        if (district.value === '') {
            document.getElementById('dcError').innerText = 'Vui lòng chọn quận huyện';
            district.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Chọn phường xã'
        if (ward.value === '') {
            ward.classList.add('is-invalid');
            isValid = false;
        }

        // Validate 'Địa chỉ Chi tiết'
        if (diachi.value.trim() === '') {
            diachi.classList.add('is-invalid');
            isValid = false;
        }

        return isValid;
    }

    $(document).ready(function () {
        let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];
        emailjs.init("ul2tyO43RSWxM2Man");

        let ship = 0;
        var tongTien = 0;

        let soLuongSPTong = 0;
        var tongTienSauKhiGiam = 0;

        function getFormValues() {

            var ten = document.getElementById('ten').value;
            var sdt = document.getElementById('sdt').value;
            var city = document.getElementById('city').value;
            var district = document.getElementById('district').value;
            var ward = document.getElementById('ward').value;
            var diachi = document.getElementById('diachi').value;
            var email = document.getElementById('email').value;
            var ghichu = document.getElementById('ghichu').value;
            var dc = document.getElementById('dc').value;

            console.log('Tên Khách Hàng:', ten);
            console.log('Số Điện Thoại:', sdt);
            console.log('Tỉnh Thành:', city);
            console.log('Quận Huyện:', district);
            console.log('Phường Xã:', ward);
            console.log('Địa chỉ Chi tiết:', diachi);
            console.log('Email:', email);
            console.log('Ghi Chú:', ghichu);
            console.log('Địa chỉ (hidden field):', dc);
        }


        const formatVND = (tongtien) => {
            return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
        }


        const DateNow = new Date();
        const DateShip = DateNow.setDate(DateNow.getDate() + 4);

        $('#thoiGianDuKien').text(formatDateFromTimestamp(DateShip))

        function formatDateFromTimestamp(timestamp) {
            const date = new Date(timestamp);

            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }

        $(document).ready(function () {
            $('#btnCOD').click(function () {
                $(this).addClass('active');
                $('#btnVNPAY').removeClass('active');
            });

            $('#btnVNPAY').click(function () {
                $(this).addClass('active');
                $('#btnCOD').removeClass('active');
            });
        });


        function hienThiSanPhamDaChon() {
            let list = "";
            if (Array.isArray(selectedProducts) && selectedProducts.length > 0) {
                for (let i = 0; i < selectedProducts.length; i++) {
                    const item = selectedProducts[i];
                    tongTien += item.quantity * item.giabansp;

                    soLuongSPTong += parseInt(item.quantity);
                    list += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${i + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap flex">
                            <div>
                                <img src="${item.anhspmoi}" alt="Ảnh" class="w-24 h-auto mt-2">
                            </div>
                            <div class="m-4 font-bold"><span>${item.tenspmoi}</span></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.size}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(item.giabansp)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${formatVND(item.quantity * item.giabansp)}</td>
                    </tr>
            `;
                }

                tongTienSauKhiGiam = tongTien;

                $('#soLuongVaTongTien').html(`
            <div>Tổng số tiền(${soLuongSPTong} sản phẩm): <span class="text-orange-500 text-xl ml-5">${formatVND(tongTien)}</span></div>
        `);


                $('#tongTien').text(formatVND(tongTien));
                $('#phiVanChuyen').text(ship);
                $('#tongThanhToan').text(formatVND(tongTien));


            } else {
                list = "<p>Không có sản phẩm nào được chọn.</p>";
            }

            $("#danhSachSanPham").html(list);


        }

        $("#datHang").off('click', '.tiepTuc').on('click', '.tiepTuc', function () {
            var ten = document.getElementById('ten').value;
            var sdt = document.getElementById('sdt').value;
            var dc = document.getElementById('dc').value;


            var diachi = document.getElementById('diachi').value;
            if(validateForm()== true){
                if ($('#btnCOD').hasClass('active')) {


                    let ship2 = ship;
                    var tongTien2 = tongTien;
                    let nguoiNhan2 = ten;
                    let sdtNguoiNhan2 = sdt;
                    let diaChiNguoiNhan = diachi + ',' + dc;
                    var tongTienSauKhiGiam2 = tongTien;

                    taoHoaDonDatHang(nguoiNhan2, tongTien2, ship2, sdtNguoiNhan2, diaChiNguoiNhan);
                    getFormValues();

                    window.location.href = '/Client';

                } else if ($('#btnVNPAY').hasClass('active')) {
                    let ship2 = ship;
                    var tongTien2 = tongTien;
                    let nguoiNhan2 = ten;
                    let sdtNguoiNhan2 = sdt;
                    let diaChiNguoiNhan = diachi + ',' + dc;
                    var tongTienSauKhiGiam2 = tongTien;

                    taoHoaDonDatHangTraTruoc(nguoiNhan2, tongTien2, ship2, sdtNguoiNhan2, diaChiNguoiNhan, tongTienSauKhiGiam2);

                } else {
                    alert("Vui lòng chọn phương thức thanh toán.");
                }
            }
        });
        // function thongTinNguoiMua(dckh) {
        //
        //     if (dckh.trangThai == 1) {
        //         $('#diaChiKhachHang').html(`
        //             <div class="flex">
        //                 <p class="font-bold">${dckh.idKH.ten} |<span class="font-normal ml-1">${dckh.idKH.sdt}</span> <span id="diaChiSpan" class="font-normal ml-4">${dckh.soNha}, ${dckh.phuongXa}, ${dckh.quanHuyen}, ${dckh.thanhPho}</span></p>
        //                 <button class=" ml-10 bg-blue-500 hover:bg-blue-700 text-white px-2 rounded">
        //                     Mặc định
        //                 </button>
        //                 <a class="ml-10 text-blue-700"><button id="thayDoiDiaChi">Thay đổi</button></a>
        //             </div>
        //         `);
        //     }
        // }
        //
        // function getKhachHang() {
        //     $.ajax({
        //         url: '/api/session/user',
        //         method: 'GET',
        //         success: function (response) {
        //             idKhachHang = response.id;
        //             nguoiNhan = response.ten;
        //             sdtNguoiNhan = response.sdt;
        //             getDuLieu(idKhachHang);
        //             getDiaChiKhachHang(response);
        //
        //
        //         },
        //     });
        // }
        //
        // function getDuLieu(idKhachHang) {
        //     $.ajax({
        //         url: `/api/gio-hang/cho-thanh-toan/${idKhachHang}`,
        //         method: 'GET',
        //         success: function (response) {
        //             thongTinNguoiMua(response.diaChiKH[0]);
        //             console.log(selectedProducts[0].id);
        //
        //         },
        //     });
        // }

        function chuyenKhoan(amount, TxnRef, nguoiNhan, tongTienSauKhiGiam, now, email) {

            $.ajax({
                url: `/api/payment/create_payment?amount=${amount}&TxnRef=${TxnRef}&chuyenTrang=1`,
                method: 'GET',
                contentType: 'application/json',
                data: {},
                success: function (response) {
                    window.location.href = response.url;
                    sendEmail(email, tongTienSauKhiGiam, now, TxnRef, nguoiNhan);

                },
            });
        }


        function sendEmail(mail, tien, ngay, mahd, tennguoinhan) {
            const emailParams = {
                from_name: 'shosee',
                from_email: 'sneakershoesee123@gmail.com',
                tong_tien: tien,
                to_name: mail,
                ngay_gui: ngay,
                ma_hd: mahd,
                ten_nguoi_nhan: tennguoinhan,
                tong_sanpham: soLuongSPTong,
            };

            emailjs.send('service_hrrzfls', 'template_x7uwxdv', emailParams)
                .then(function (response) {
                }, function (error) {
                });
        }

        function taoHoaDonDatHangTraTruoc(nguoiNhan, tongTien, tienShip, sdtNguoiNhan, diaChiNguoinhan, tongTienSauKhiGiam) {
            var ghichu = document.getElementById('ghichu').value;
            $.ajax({
                url: `/api/gio-hang/tao-hoa-don-dat-hang-khong-dang-nhap`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({

                    ma: "1",
                    nguoiNhan: nguoiNhan,
                    tongTien: tongTien,
                    tongTienSauGiam: tongTienSauKhiGiam,
                    tienShip: tienShip,
                    sdtNguoiNhan: sdtNguoiNhan,
                    diaChiNguoiNhan: diaChiNguoinhan,
                    ghiChu: ghichu,

                }),
                success: function (response) {
                    const idHoaDon = response.id;
                    addHistoryLog(idHoaDon);
                    addSanPhamVaoHDCT(idHoaDon);
                    addPhuongThucThanhToanChuyenKhoan(idHoaDon, tongTienSauKhiGiam)
                    const now = new Date();
                    var email = document.getElementById('email').value;
                    chuyenKhoan(response.tongTienSauGiam, response.ma, nguoiNhan, tongTienSauKhiGiam, now, email);
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tạo hóa đơn:', error,);
                }
            });
        }


        function taoHoaDonDatHang(nguoiNhan, tongTien, tienShip, sdtNguoiNhan, diaChiNguoinhan) {
            // let idPhieuGiamGia = sale[0].id
            var ghichu = document.getElementById('ghichu').value;
            $.ajax({
                url: `/api/gio-hang/tao-hoa-don-dat-hang-khong-dang-nhap`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({

                    ma: "1",
                    nguoiNhan: nguoiNhan,
                    tongTien: tongTien,
                    tongTienSauGiam: tongTien,
                    tienShip: tienShip,
                    sdtNguoiNhan: sdtNguoiNhan,
                    diaChiNguoiNhan: diaChiNguoinhan,
                    ghiChu: ghichu,

                }),
                success: function (response) {
                    var email = document.getElementById('email').value;
                    const idHoaDon = response.id;
                    addHistoryLog(idHoaDon);
                    addSanPhamVaoHDCT(idHoaDon);
                    addPhuongThucThanhToan(idHoaDon, tongTien)
                    const now = new Date();
                    var tienguimail = `${formatVND(tongTien)}`;
                    sendEmail(email, tienguimail, now, response.ma, nguoiNhan);

                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi tạo hóa đơn:', error);
                }
            });
        }


        function addHistoryLog(idHoaDon) {

            $.ajax({
                url: `/api/hoa-don/lich-su-hoa-don/add/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ghiChu: "Chờ xác nhận", hanhDong: 1}),
                success: function (response) {
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi khi thêm lịch sử:', error);
                }
            });
        }

        function addSanPhamVaoHDCT(idHoaDon) {
            let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];
            selectedProducts.forEach(product => {

                const productData = {
                    sanPhamChiTiet: product,
                    soLuong: product.quantity,
                    gia: product.giabansp,
                    trangThai: 1
                };
                $.ajax({
                    url: `/api/gio-hang/them-san-pham-vao-hoa-don/${idHoaDon}`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(productData),
                    success: function (response) {

                        console.log("id"+product.id)
                        console.log( product.quantity)
                        // deleteByIDGHCT(product.id);
                        // updateSoLuongSP(product.id, product.quantity);

                        console.log("id" + product.id)
                        console.log(product.quantity)
                        deleteByIDGHCT(product.id);
                        updateSoLuongSP(product.id, product.quantity);
                        removeProductById(product.id);

                    },
                    error: function (xhr, status, error) {

                    }
                });


            });
            localStorage.removeItem('selectedProducts');
        }

        function removeProductById(productId) {
            const cart = JSON.parse(sessionStorage.getItem('cart')) || [];
            const updatedCart = cart.filter(product => product.id !== productId);
            sessionStorage.setItem('cart', JSON.stringify(updatedCart));
        }




        // function updateSoLuongSP(idSPCT, soLuong){
        //     $.ajax({
        //         url: `/api/gio-hang/update-so-luong-sp-sau-khi-thanh-toan/${idSPCT}`,
        //         method: 'PUT',
        //         contentType: 'application/json',
        //         data: JSON.stringify({
        //             soLuong: soLuong
        //         }),
        //         success: function () {
        //
        //         },
        //
        //     });
        // }

        function updateSoLuongSP(idSPCT, soLuong) {
            $.ajax({
                url: `/api/gio-hang/update-so-luong-sp-sau-khi-thanh-toan/${idSPCT}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    soLuong: soLuong
                }),
                success: function () {

                },

            });
        }


        function addPhuongThucThanhToan(idHoaDon, tongTien) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenThanhToan: "Tiền mặt",
                    loaiThanhToan: false,
                    tienDaThanhToan: tongTien,
                    trangThai: 1
                }),
                success: function (response) {
                },
            });
        }

        function addPhuongThucThanhToanChuyenKhoan(idHoaDon, tongTien) {
            $.ajax({
                url: `/api/gio-hang/them-phuong-thuc-thanh-toan/${idHoaDon}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    tenThanhToan: "Chuyển Khoản",
                    loaiThanhToan: true,
                    tienDaThanhToan: tongTien,
                    trangThai: 1
                }),
                success: function (response) {
                },
            });
        }

        // function getDiaChiKhachHang(khachHang) {
        //     $.ajax({
        //         url: `/api/gio-hang/dia-chi-khach-hang/${khachHang.id}`,
        //         method: 'GET',
        //         success: function (response) {
        //             let list = "";
        //             $("#listDiaChi").empty();
        //
        //             response.forEach((diaChi, i) => {
        //
        //                 list += `
        //             <div class="grid gap-1 grid-cols-1 border-1 border-gray-300 p-4 rounded-lg">
        //                 <div class="flex">
        //                      <div class="radioDiaChi mr-2">
        //                             <input type="radio" name="phieuGiamGia" id="radioDiaChi" value="${diaChi.id}" data-item='${JSON.stringify(diaChi)}'>
        //                     </div>
        //                     <div class="mr-3">${khachHang.ten}</div>
        //                     <div class="text-gray-600">| ${khachHang.sdt}</div>
        //                     </div>
        //                     <div>
        //                         <div class="ml-5 text-gray-600">${`${diaChi.moTaChiTiet}, ${diaChi.thanhPho}`}</div>
        //                     </div>
        //             </div>
        //             <br>
        //         `;
        //             });
        //             $("#listDiaChi").html(list);
        //         },
        //     });
        // }


        // function deleteByIDGHCT(idGHCT){
        //     $.ajax({
        //         url: `/api/gio-hang/delete-sp/${idGHCT}`,
        //         method: 'POST',
        //         success: function () {
        //
        //         },
        //
        //     });
        // }

        function deleteByIDGHCT(idGHCT) {
            $.ajax({
                url: `/api/gio-hang/delete-sp/${idGHCT}`,
                method: 'POST',
                success: function () {

                },

            });
        }



        // function hideModalDiaChi() {
        //     $('#modalDiaChi').addClass('hidden');
        //     $('#modalDiaChi').val('');
        //     $('#modalDiaChi').addClass('hidden');
        // }
        //
        // function showModalDiaChi() {
        //     $('#modalDiaChi').removeClass('hidden');
        // }
        //
        // $(document).on('click', '#thayDoiDiaChi', function () {
        //     showModalDiaChi();
        // });


        hienThiSanPhamDaChon();
        // getKhachHang();

    });
</script>
</body>
<div th:replace="~{client/fragmentsClient/footer :: footer}"></div>
</html>