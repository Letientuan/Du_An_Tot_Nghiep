<!DOCTYPE html >
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{client/fragmentsClient/head :: head}"></div>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml"
          href="https://bizweb.dktcdn.net/100/048/601/themes/734017/assets/index-cate-icon-4.png?1610907247309"/>

    <title>Tra cứu đơn hàng</title>
    <!-- Bootstrap CSS --><!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css">

    <!-- Bootstrap JS (để hỗ trợ modal và các tính năng JavaScript khác) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .default-customer-img {
            width: 30px; /* Kích thước của ảnh */
            height: 30px; /* Kích thước của ảnh */
            border-radius: 50%; /* Làm tròn ảnh */
        }
        /* Đặt container với Flexbox */
        .account-container {
            display: flex;
            align-items: center; /* Căn giữa hình ảnh và văn bản theo chiều dọc */
        }

        /* Chỉnh kích thước và tạo hình tròn cho ảnh */
        .default-customer-img {
            width: 40px; /* Kích thước của ảnh */
            height: 40px; /* Kích thước của ảnh */
            border-radius: 50%; /* Làm tròn ảnh */
            margin-right: 10px; /* Khoảng cách giữa ảnh và văn bản */
        }

        /* Định dạng cho văn bản */
        .account-text {
            font-size: 16px; /* Kích thước chữ */
            color: #333; /* Màu chữ */
        }


    </style>

    <style>
        body {
            background-color: #f4f4f4;
        }

        .table-container {
            margin: 20px auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .table th, .table td {
            text-align: center;
            vertical-align: middle;
        }

        .search-bar {
            margin: 20px 0;
        }
    </style>
</head>
<body>
<div th:replace="~{client/fragmentsClient/header :: header}"></div>

<div class="container">
    <div class="search-bar text-center">
        <input type="text" id="orderSearchInput" class="form-control w-50 mx-auto"
               placeholder="Tra cứu đơn hàng của bạn">
        <button id="searchButton" class="btn btn-danger mt-2">Tra cứu</button>
    </div>
    <div id="searchResults" class="table-container"></div> <!-- To display the search results -->
</div>
<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <i class="bi bi-eye" style="font-size: 24px; color: #007bff;"></i>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Bảng thông tin chi tiết -->
                <div>
                    <div class="ml-5 flex">
                        <div class="ml-[50%]">
                            <h5 >Thông tin khách hàng: </h5>
                            <hr style="border: none; border-top: 3px solid #FFA500; margin: 20px 0;">
                            <span id="maHD"></span>
                            <span id="trangThai" class="text-orange-500 ml-14"></span>
                        </div>
                    </div>
                    <div>
                        <div>
                            <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>
                        </div>
                        <div class="container mx-auto px-4 py-8">
                            <div class="overflow-hidden">
                                <div class="flex items-center" id="steppers"></div>
                            </div>
                        </div>
                        <div class="w-full border-t border-gray-500 mt-1 mb-3 "></div>
                        <div class="grid gap-1 grid-cols-2">
                            <div id="diaChiNhanHang" class="mb-3"></div>
                        </div>
                        <h5>Thông tin sản phẩm: </h5>
                        <hr style="border: none; border-top: 3px solid #FFA500; margin: 20px 0;">
                        <div id="sanPhamChiTietContainer">
                            <!-- Các sản phẩm sẽ được chèn vào đây bằng JavaScript -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jarallax@1.12.0/dist/jarallax.min.js"></script>
<!-- Thêm thư viện jarallax-video (nếu cần) -->
<script src="https://cdn.jsdelivr.net/npm/jarallax@1.12.0/dist/jarallax-video.min.js"></script>
<!-- Thêm JavaScript của Chocolat -->
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script th:src="@{/assets/js/Header.js}"></script>

<script>
    const pathArray = window.location.pathname.split('/');
    const idHoaDon = pathArray[pathArray.length - 1];

    const formatVND = (tongtien) => {
        return tongtien.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + ' VNĐ';
    }

    function getKhachHang() {
        $.ajax({
            url: '/api/session/user',
            method: 'GET',
            success: function (response) {
                let idKhachHang = response.id;
                $('#tenKhachHang').text(response.ten);
            },
        });
    }

    function fetchHoaDonDetail(idHoaDon) {
        $.ajax({

            url: `/api/hoa-don/detail/${idHoaDon}`,
            method: 'GET',
            success: function (response) {
                console.log(response);
                const hd = response.hd;
                const hdctList = response.hdctList;
                thongTinDiaChiDonHang(hd);
                fetchStepsData(idHoaDon);
                currentStep = hd.id;
            },
        });
    }

    function thongTinDiaChiDonHang(hd){
        $('#diaChiNhanHang').html(`
           <div id="diaChiNhanHang" class="mb-3">
                           <div style="font-size: 17px; font-weight: bold; margin-bottom: 10px;">Tên người nhận: ${hd.nguoiNhan}</div>

                <div class="row">
                    <div class="col-md-6">
                        <div style="font-size: 15px; margin-bottom: 5px;">Số điện thoại: ${hd.sdtNguoiNhan}</div>
                        <div style="font-size: 15px; margin-bottom: 5px;">Địa chỉ: ${hd.diaChiNguoiNhan}</div>
                    </div>
                    <div class="col-md-4">
                        <div style="font-size: 15px; margin-bottom: 5px;">Ngày Giao dự kiến: ${hd.ngayGiaoHang}</div>
                        <div style="font-size: 15px; margin-bottom: 5px;">Thanh toán: ${hd.tongTienSauGiam}</div>
                    </div>
                </div>
            </div>


        `);

        $('#thanhToan').html(`
            <div class="flex">
                <div class="ml-[45%]">
                    <div class="text-gray-600 ml-9 ">Tổng tiền: </div>
                    <div class="text-gray-600">Phí vận chuyển: </div>
                    <div class="text-gray-600 ml-12">Voucher: </div>
                    <div class="font-bold ml-6">Thành tiền: </div>
                </div>
                <div class="ml-[10%]">
                    <div class="text-gray-600">${formatVND(hd.tongTien)}</div>
                    <div class="text-gray-600">${formatVND(hd.tienShip)}</div>
                    <div class="text-gray-600">${formatVND(hd.phieuGiamGia.giamToiDa)}</div>
                    <div class="text-orange-600 text-xl">${formatVND(hd.tongTienSauGiam)}</div>
                </div>
            </div>
        `);

        $('#maHD').text(`${encodeURIComponent(ma)}`);
        $('#trangThai').text(`${trangThaiSteps(hd.trangThai)}`);
    }

    document.getElementById('searchButton').addEventListener('click', function () {
        var ma = document.getElementById('orderSearchInput').value;
        if (ma.trim() === '') {
            alert('Vui lòng nhập mã đơn hàng.');
            return;
        }

        var url = 'http://localhost:3000/tra-cuu-hoa-don/' + encodeURIComponent(ma);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
                return response.json();
            })
            .then(data => {
                var resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = ''; // Clear previous results

                if (data && data.length > 0) {
                    var table = document.createElement('table');
                    table.classList.add('table', 'table-striped', 'table-bordered', 'table-hover');
                    table.style.width = '100%';

                    var thead = document.createElement('thead');
                    var headerRow = document.createElement('tr');
                    var headers = ['STT', 'Tên Người Nhận', 'SDT', 'Tổng Tiền', 'Ngày Giao Dự Kiến', 'Hành Động'];

                    headers.forEach(header => {
                        var th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });

                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    var tbody = document.createElement('tbody');
                    data.forEach((item, index) => {
                        var row = document.createElement('tr');

                        var tdSTT = document.createElement('td');
                        tdSTT.textContent = index + 1; // STT (Serial Number)
                        row.appendChild(tdSTT);

                        var tdName = document.createElement('td');
                        tdName.textContent = item.nguoiNhan || 'N/A'; // Adjust field name
                        row.appendChild(tdName);

                        var tdPhone = document.createElement('td');
                        tdPhone.textContent = item.sdtNguoiNhan || 'N/A'; // Adjust field name
                        row.appendChild(tdPhone);

                        var tdTotal = document.createElement('td');
                        tdTotal.textContent = item.tongTien || 'N/A'; // Adjust field name
                        row.appendChild(tdTotal);

                        var tdNgayGiao = document.createElement('td');
                        tdNgayGiao.textContent = item.ngayGiaoDuKien || 'N/A'; // Adjust field name
                        row.appendChild(tdNgayGiao);

                        var tdActions = document.createElement('td');
                        var actionButton = document.createElement('button');
                        actionButton.textContent = 'Xem Chi tiết';
                        actionButton.classList.add('btn', 'btn-info', 'btn-sm');
                        actionButton.onclick = function () {
                            $.ajax({
                                url: `/tra-cuu-hoa-don-chi-tiet/${encodeURIComponent(item.ma)}`, // Đảm bảo endpoint đúng
                                type: 'GET',
                                success: function (response) {
                                    console.log('Detail Response:', response);

                                    // Xóa nội dung cũ trong container (nếu có)
                                    const sanPhamChiTietContainer = document.getElementById('sanPhamChiTietContainer');
                                    sanPhamChiTietContainer.innerHTML = ''; // Xóa các nội dung cũ

                                    // Lặp qua danh sách sanPhamChiTiet
                                    response.forEach(item => {
                                        const sanPhamChiTiet = item.sanPhamChiTiet;
                                        const productPrice = sanPhamChiTiet.giaBan * sanPhamChiTiet.soLuong != null ? sanPhamChiTiet.giaBan.toLocaleString('vi-VN', {
                                            style: 'currency',
                                            currency: 'VND'
                                        }) : 'Không có giá';

                                        // Tạo một div chứa thông tin sản phẩm
                                        const productDiv = document.createElement('div');
                                        productDiv.classList.add('grid', 'gap-4', 'grid-cols-2', 'mb-4'); // Chia thành 2 cột

                                        // Hình ảnh sản phẩm (cột bên trái)
                                        productDiv.innerHTML = `
                                    <div class="row g-4" style="max-width: 800px;">
                                        <div class="col d-flex p-4">
                                            <div class="flex-shrink-0">
                                                <img src="${sanPhamChiTiet.anh}" alt="Ảnh" class="img-fluid rounded-lg shadow" style="width: 100px;height: 100px">
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <div class="fs-5 fw-semibold text-dark">${sanPhamChiTiet.ten}</div>
                                                <div class="d-flex align-items-center mt-2">
                                                    <span class="text-muted">${sanPhamChiTiet.kichCo.ten} - </span>
                                                    <div class="rounded-circle ms-2 border border-secondary" style="background-color: ${sanPhamChiTiet.mauSac.ten}; width: 20px; height: 20px;"></div>
                                                </div>
                                                <div class="mt-2 text-muted">Số lượng: <span class="fw-medium">${sanPhamChiTiet.soLuong}</span></div>
                                            </div>
                                        </div>

                                        <div class="col mt-4" style="margin-top: 35px">
                                            <div class="fs-6 text-danger" style="margin-top: 35px">
                                                ${(productPrice)}<span></span>
                                            </div>
                                        </div>
                                    </div>

                                <div class="ml-5 w-[95%] h-0.5 bg-gray-300 mt-4"></div>
                `;

                                        // Thêm div sản phẩm vào container
                                        sanPhamChiTietContainer.appendChild(productDiv);
                                    });

                                    // Mở modal
                                    var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                                    detailModal.show();
                                },
                                error: function (xhr, status, error) {
                                    console.error('Lỗi khi lấy chi tiết hóa đơn:', error);
                                }
                            });
                            fetchHoaDonDetail(item.id)
                        };

                        tdActions.appendChild(actionButton);

                        row.appendChild(tdActions);
                        tbody.appendChild(row);
                    });

                    table.appendChild(tbody);
                    resultsDiv.appendChild(table);
                } else {
                    resultsDiv.textContent = 'No results found.';
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                alert('An error occurred while fetching the data.');
            });
    });
</script>
<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
</body>
</html>
